{{- if eq .chezmoi.os "darwin" "linux" -}}
#!/bin/sh

# Hash of dependent scripts to trigger re-run:
# 01: {{ include ".chezmoiscripts/.scripts/01-system-packages.zsh.tmpl" | sha256sum }}
# 02: {{ include ".chezmoiscripts/.scripts/02-shell-config.zsh.tmpl" | sha256sum }}

SCRIPT_DIR="{{ .chezmoi.sourceDir }}/.chezmoiscripts/.scripts"

# Prevent zsh-newuser-install wizard by creating .zshrc if missing
if [ ! -f "$HOME/.zshrc" ]; then
    touch "$HOME/.zshrc"
fi

# Function to render and run a script
run_script() {
    local script_name="$1"
    local interpreter="$2"
    
    if [ -f "$SCRIPT_DIR/$script_name" ]; then
        # Render and execute
        # We use 'cat' to read the source file, then 'chezmoi execute-template' to render it.
        # We pipe to the specified interpreter (sh or zsh).
        cat "$SCRIPT_DIR/$script_name" | chezmoi execute-template | "$interpreter"
    else
        echo "Error: Script $script_name not found at $SCRIPT_DIR/$script_name"
        return 1
    fi
}

# Refresh sudo credentials
if command -v sudo >/dev/null 2>&1; then
    sudo -v
fi

echo "Starting Phased Parallel Installation..."

# --- PHASE 1: Independent Tasks & Core Deps ---
# Run with 'sh' because zsh might not be installed yet (e.g. fresh Linux)
echo "--- Phase 01 (Core Deps) ---"
pids=()

for script in "$SCRIPT_DIR"/01-*.zsh.tmpl; do
    if [ -e "$script" ]; then
        base_name=$(basename "$script")
        echo "Starting: $base_name"
        run_script "$base_name" "sh" &
        pids+=($!)
    fi
done

wait "${pids[@]}"
if [ $? -ne 0 ]; then
    echo "❌ Phase 01 failed. Aborting."
    exit 1
fi
echo "✅ Phase 01 complete."

# --- PHASE 2: Dependent Configuration ---
# Run with 'zsh' because it should be installed now
echo "--- Phase 02 (Configuration) ---"
pids=()

# Fallback to sh if zsh still isn't found (shouldn't happen if Phase 1 worked)
INTERPRETER="zsh"
if ! command -v zsh >/dev/null 2>&1; then
    echo "⚠️ zsh not found despite Phase 1. Falling back to sh."
    INTERPRETER="sh"
fi

for script in "$SCRIPT_DIR"/02-*.zsh.tmpl; do
    if [ -e "$script" ]; then
        base_name=$(basename "$script")
        echo "Starting: $base_name"
        run_script "$base_name" "$INTERPRETER" &
        pids+=($!)
    fi
done

wait "${pids[@]}"
if [ $? -ne 0 ]; then
    echo "❌ Phase 02 failed."
    exit 1
fi

echo "✨ All Phases Complete!"
{{- end -}}

